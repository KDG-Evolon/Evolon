<!DOCTYPE html>
<html lang="ja" xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8">
  <title th:text="${item.id == null ? '商品出品' : '商品編集'}"></title>
  <link rel="stylesheet" th:href="@{/css/style.css}">
</head>
<body>
<div class="container">
  <h1 th:text="${item.id == null ? '商品出品' : '商品編集'}"></h1>

  <form th:action="${item.id == null ? '/items' : '/items/' + item.id}" method="post" enctype="multipart/form-data">
    <input type="hidden" th:if="${item.id != null}" name="_method" value="put">

    <!-- 基本情報 -->
    <p>
      <label for="name">商品名:</label>
      <input type="text" id="name" name="name" th:value="${item.name}" required>
    </p>

    <p>
      <label for="description">商品説明:</label>
      <textarea id="description" name="description" th:text="${item.description}"></textarea>
    </p>

    <p>
      <label for="price">価格 (¥):</label>
      <input type="number" id="price" name="price" th:value="${item.price}" step="0.01" required>
    </p>

    <!-- カテゴリ -->
    <p>
      <label for="categoryId">カテゴリ:</label>
      <select id="categoryId" name="categoryId" required>
        <option value="" disabled selected>選択してください</option>
        <option th:each="category : ${categories}" th:value="${category.id}" th:text="${category.name}"
                th:selected="${item.category != null and item.category.id == category.id}"></option>
      </select>
    </p>

    <!-- 商品画像（出品用） -->
    <p>
      <label for="image">商品画像:</label>
      <input type="file" id="image" name="image" accept="image/*">
      <span th:if="${item.imageUrl}">
        現在の画像:
        <img th:src="${item.imageUrl}" style="width:100px; height:auto;">
      </span>
    </p>

    <!-- OCR用画像（カード自動入力用） -->
    <p>
      <label for="cardImage">カード情報OCR用画像:</label>
      <input type="file" id="cardImage" accept="image/*">
    </p>

    <!-- カード情報 -->
    <div id="cardFields" style="display:none;">
      <p>
        <label for="cardNumberText">カード番号:</label>
        <input type="text" id="cardNumberText" placeholder="例: sv8a 212/187">
        <button type="button" id="autoFillBtn">自動入力</button>
      </p>

      <p>
        <label for="cardName">カード名:</label>
        <input type="text" id="cardName" name="cardInfo.cardName"
               th:value="${item.cardInfo != null ? item.cardInfo.cardName : ''}" required>
      </p>

      <p>
        <label for="rarity">レアリティ:</label>
        <select id="rarity" name="cardInfo.rarity" required>
          <option value="" selected>選択してください</option>
          <option th:each="r : ${rarities}" th:value="${r.name()}" th:text="${r.label}"
                  th:selected="${item.cardInfo != null ? item.cardInfo.rarity == r : false}"></option>
        </select>
      </p>

      <p>
        <label for="packName">封入パック:</label>
        <input type="text" id="packName" name="cardInfo.packName"
               th:value="${item.cardInfo != null ? item.cardInfo.packName : ''}" required>
      </p>

      <p>
        <label for="condition">状態:</label>
        <select id="condition" name="cardInfo.condition" required>
          <option value="" selected>選択してください</option>
          <option th:each="c : ${conditions}" th:value="${c.name()}" th:text="${c.label}"
                  th:selected="${item.cardInfo != null ? item.cardInfo.condition == c : false}"></option>
        </select>
      </p>

      <p>
        <label for="regulation">レギュレーション:</label>
        <select id="regulation" name="cardInfo.regulation" required>
          <option value="" selected>選択してください</option>
          <option th:each="r : ${regulations}" th:value="${r.name()}" th:text="${r.label}"
                  th:selected="${item.cardInfo != null ? item.cardInfo.regulation == r : false}"></option>
        </select>
      </p>
    </div>

    <div class="button-group">
      <button type="submit" class="button primary" th:text="${item.id == null ? '出品する' : '更新する'}"></button>
      <a th:href="@{/items}" class="button secondary">キャンセル</a>
    </div>
  </form>
</div>

<script>
// カテゴリに応じてカード欄表示
function toggleCardFields() {
  const categorySelect = document.getElementById('categoryId');
  const cardFields = document.getElementById('cardFields');
  if (!categorySelect || !cardFields) return;

  const selectedText = categorySelect.options[categorySelect.selectedIndex]?.text?.trim();
  const isCard = (selectedText === 'カード');

  cardFields.style.display = isCard ? 'block' : 'none';

  ['cardName', 'packName', 'rarity', 'condition', 'regulation'].forEach(id => {
    const el = document.getElementById(id);
    if (el) el.required = isCard;
    if (!isCard && el) el.value = '';
  });
}

document.addEventListener('DOMContentLoaded', () => {
  toggleCardFields();
  document.getElementById('categoryId')?.addEventListener('change', toggleCardFields);
});

// ====================
// OCR自動入力
// ====================
async function doOcrAndFill(file) {
  if (!file) return;
  const formData = new FormData();
  formData.append('image', file);

  try {
    const res = await fetch('/api/ocr', { method: 'POST', body: formData });
    if (!res.ok) return console.warn("OCRに失敗");

    const data = await res.json();
    const parsed = data.parsed;
    const card = data.card;

    if (!parsed) return;

    // カード番号欄
    if (parsed.setCode && parsed.cardNumber) {
      document.getElementById('cardNumberText').value =
        `${parsed.setCode} ${parsed.cardNumber}`;
      document.getElementById('cardFields').style.display = 'block';
    }

    // マスタ一致時のみ反映
    if (card) {
      document.getElementById('cardName').value = card.cardName ?? '';
      document.getElementById('rarity').value = card.rarity ?? '';
      document.getElementById('packName').value = card.packName ?? '';
      document.getElementById('regulation').value = card.printedRegulation ?? '';
    }
  } catch (err) {
    console.error(err);
  }
}

// OCR用画像変更時に自動入力
document.getElementById('cardImage')?.addEventListener('change', e => {
  const file = e.target.files[0];
  doOcrAndFill(file);
});

// OCR自動入力ボタン（商品画像でも可能）
document.getElementById('autoFillBtn')?.addEventListener('click', () => {
  const file = document.getElementById('image')?.files[0];
  if (!file) return alert('画像を選択してください');
  doOcrAndFill(file);
});
</script>
</body>
</html>
